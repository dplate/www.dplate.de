<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="icons.html">
<link rel="import" href="menu.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        display: block;
        --primary-background-color: #9EC1A3;
      }

      app-header {
        background-color: #CFE0C3;
        vertical-align: middle;
      }

      app-header div {
        text-align: right;
        padding-right: 20px;
      }

      app-drawer {
        --app-drawer-width: 200px;
        --app-drawer-content-container: {
          background-color: #9EC1A3;
          box-shadow: 1px 0 1px 0 rgba(255,255,255,0.3);
        }
      }

      app-drawer div {
        height: 100%;
        overflow: auto;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <iron-ajax id="itemsLoader" url="items.json" handle-as="json" last-response="{{items}}"></iron-ajax>

    <app-drawer-layout fullbleed align="left" id="drawerLayout">
      <app-header-layout has-scrolling-region id="headerLayout">
        <app-header condenses reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div main-title>www.dplate.de</div>
            <img src="/images/icons/icon-48x48.png" />
          </app-toolbar>
        </app-header>
        <iron-pages selected="[[route.path]]" attr-for-selected="name" fallback-selection="/404" role="main" id="pages">
          <my-page-start name="/" items="[[items]]"></my-page-start>
          <my-page-games-schiffbruch name="/games/schiffbruch"></my-page-games-schiffbruch>
          <my-page-games-modracer name="/games/modracer"></my-page-games-modracer>
          <my-page-games-cannonhill name="/games/cannonhill"></my-page-games-cannonhill>
          <my-page-games-ancient name="/games/ancient"></my-page-games-ancient>
          <my-page-tools-scapemaker name="/tools/scapemaker"></my-page-tools-scapemaker>
          <my-page-tools-kensentme name="/tools/kensentme"></my-page-tools-kensentme>
          <my-page-impressum name="/impressum"></my-page-impressum>
          <my-page-404 name="/404"></my-page-404>
          <my-page-photos name="/photos"></my-page-photos>
          <my-page-alpine-flumserberg-20161112 name="/alpine/flumserberg/20161112"></my-page-alpine-flumserberg-20161112>
          <my-page-alpine-lenzerheide-20161029 name="/alpine/lenzerheide/20161029"></my-page-alpine-lenzerheide-20161029>
          <my-page-alpine-malbun-20161016 name="/alpine/malbun/20161016"></my-page-alpine-malbun-20161016>
          <my-page-alpine-alpstein-20160911 name="/alpine/alpstein/20160911"></my-page-alpine-alpstein-20160911>
          <my-page-alpine-toggenburg-20160813 name="/alpine/toggenburg/20160813"></my-page-alpine-toggenburg-20160813>
          <my-page-alpine-murgseen-20160709 name="/alpine/murgseen/20160709"></my-page-alpine-murgseen-20160709>
          <my-page-alpine-alpstein-20160730 name="/alpine/alpstein/20160730"></my-page-alpine-alpstein-20160730>
          <my-page-alpine-fronalpstock-20160716 name="/alpine/fronalpstock/20160716"></my-page-alpine-fronalpstock-20160716>
          <my-page-alpine-kaunertal-20151124 name="/alpine/kaunertal/20151124"></my-page-alpine-kaunertal-20151124>
          <my-page-alpine-davos-20151031 name="/alpine/davos/20151031"></my-page-alpine-davos-20151031>
          <my-page-alpine-alpstein-20151024 name="/alpine/alpstein/20151024"></my-page-alpine-alpstein-20151024>
          <my-page-alpine-davos-20151010 name="/alpine/davos/20151010"></my-page-alpine-davos-20151010>
          <my-page-alpine-alpstein-20150912 name="/alpine/alpstein/20150912"></my-page-alpine-alpstein-20150912>
          <my-page-alpine-brandnertal-20150829 name="/alpine/brandnertal/20150829"></my-page-alpine-brandnertal-20150829>
          <my-page-alpine-gargellen-20150822 name="/alpine/gargellen/20150822"></my-page-alpine-gargellen-20150822>
          <my-page-alpine-davos-20150808 name="/alpine/davos/20150808"></my-page-alpine-davos-20150808>
          <my-page-alpine-flumserberg-20150726 name="/alpine/flumserberg/20150726"></my-page-alpine-flumserberg-20150726>
          <my-page-alpine-pizol-20150712 name="/alpine/pizol/20150712"></my-page-alpine-pizol-20150712>
          <my-page-alpine-hohekugel-20150628 name="/alpine/hohekugel/20150628"></my-page-alpine-hohekugel-20150628>
          <my-page-alpine-speer-20150606 name="/alpine/speer/20150606"></my-page-alpine-speer-20150606>
          <my-page-alpine-disentis-20150514 name="/alpine/disentis/20150514"></my-page-alpine-disentis-20150514>
          <my-page-alpine-lenzerheide-20150318 name="/alpine/lenzerheide/20150318"></my-page-alpine-lenzerheide-20150318>
          <my-page-alpine-toggenburg-20150323 name="/alpine/toggenburg/20150323"></my-page-alpine-toggenburg-20150323>
          <my-page-alpine-airolo-20150222 name="/alpine/airolo/20150222"></my-page-alpine-airolo-20150222>
          <my-page-alpine-arlberg-20150207 name="/alpine/arlberg/20150207"></my-page-alpine-arlberg-20150207>
          <my-page-alpine-arlberg-20150131 name="/alpine/arlberg/20150131"></my-page-alpine-arlberg-20150131>
          <my-page-alpine-montafon-20150110 name="/alpine/montafon/20150110"></my-page-alpine-montafon-20150110>
          <my-page-alpine-brandnertal-20141229 name="/alpine/brandnertal/20141229"></my-page-alpine-brandnertal-20141229>
          <my-page-alpine-flumserberg-20141227 name="/alpine/flumserberg/20141227"></my-page-alpine-flumserberg-20141227>
          <my-page-alpine-ischgl-20141217 name="/alpine/ischgl/20141217"></my-page-alpine-ischgl-20141217>
          <my-page-alpine-montafon-20141215 name="/alpine/montafon/20141215"></my-page-alpine-montafon-20141215>
          <my-page-alpine-davos-20141122 name="/alpine/davos/20141122"></my-page-alpine-davos-20141122>
          <my-page-alpine-laax-20141209 name="/alpine/laax/20141209"></my-page-alpine-laax-20141209>
          <my-page-alpine-sankt-moritz-20141210 name="/alpine/sankt-moritz/20141210"></my-page-alpine-sankt-moritz-20141210>
          <my-page-alpine-hoher-freschen-20141129 name="/alpine/hoher-freschen/20141129"></my-page-alpine-hoher-freschen-20141129>
          <my-page-alpine-alpstein-20141102 name="/alpine/alpstein/20141102"></my-page-alpine-alpstein-20141102>
          <my-page-alpine-grasgehren-20141026 name="/alpine/grasgehren/20141026"></my-page-alpine-grasgehren-20141026>
          <my-page-alpine-alvier-20140907 name="/alpine/alvier/20140907"></my-page-alpine-alvier-20140907>
          <my-page-alpine-boedele-20140927 name="/alpine/boedele/20140927"></my-page-alpine-boedele-20140927>
          <my-page-alpine-toggenburg-20140928 name="/alpine/toggenburg/20140928"></my-page-alpine-toggenburg-20140928>
          <my-page-alpine-sulzfluh-20141012 name="/alpine/sulzfluh/20141012"></my-page-alpine-sulzfluh-20141012>
          <my-page-alpine-alpstein-20131019 name="/alpine/alpstein/20131019"></my-page-alpine-alpstein-20131019>
          <my-page-alpine-alpstein-20140622 name="/alpine/alpstein/20140622"></my-page-alpine-alpstein-20140622>
          <my-page-alpine-alpstein-20140801 name="/alpine/alpstein/20140801"></my-page-alpine-alpstein-20140801>
          <my-page-alpine-ischgl-20140504 name="/alpine/ischgl/20140504"></my-page-alpine-ischgl-20140504>
          <my-page-alpine-toggenburg-20140329 name="/alpine/toggenburg/20140329"></my-page-alpine-toggenburg-20140329>
          <my-page-alpine-davos-20140409 name="/alpine/davos/20140409"></my-page-alpine-davos-20140409>
          <my-page-alpine-arlberg-20140411 name="/alpine/arlberg/20140411"></my-page-alpine-arlberg-20140411>
          <my-page-alpine-lenzerheide-20140331 name="/alpine/lenzerheide/20140331"></my-page-alpine-lenzerheide-20140331>
          <my-page-alpine-serfaus-fiss-ladis-20140407 name="/alpine/serfaus-fiss-ladis/20140407"></my-page-alpine-serfaus-fiss-ladis-20140407>
          <my-page-alpine-flumserberg-20140403 name="/alpine/flumserberg/20140403"></my-page-alpine-flumserberg-20140403>
          <my-page-alpine-montafon-20140404 name="/alpine/montafon/20140404"></my-page-alpine-montafon-20140404>
          <my-page-alpine-arlberg-20140401 name="/alpine/arlberg/20140401"></my-page-alpine-arlberg-20140401>
          <my-page-alpine-titlis-20140302 name="/alpine/titlis/20140302"></my-page-alpine-titlis-20140302>
          <my-page-alpine-savognin-20140315 name="/alpine/savognin/20140315"></my-page-alpine-savognin-20140315>
          <my-page-alpine-pizol-20140228 name="/alpine/pizol/20140228"></my-page-alpine-pizol-20140228>
          <my-page-alpine-laax-20140222 name="/alpine/laax/20140222"></my-page-alpine-laax-20140222>
          <my-page-alpine-andermatt-20140112 name="/alpine/andermatt/20140112"></my-page-alpine-andermatt-20140112>
          <my-page-alpine-sankt-moritz-20161207 name="/alpine/sankt-moritz/20161207"></my-page-alpine-sankt-moritz-20161207>
          <my-page-alpine-ischgl-20131221 name="/alpine/ischgl/20131221"></my-page-alpine-ischgl-20131221>
          <my-page-alpine-damuels-20131213 name="/alpine/damuels/20131213"></my-page-alpine-damuels-20131213>
          <my-page-alpine-arlberg-20131217 name="/alpine/arlberg/20131217"></my-page-alpine-arlberg-20131217>
          <my-page-alpine-montafon-20131216 name="/alpine/montafon/20131216"></my-page-alpine-montafon-20131216>
          <my-page-alpine-lenzerheide-20131214 name="/alpine/lenzerheide/20131214"></my-page-alpine-lenzerheide-20131214>
          <my-page-alpine-davos-20131116 name="/alpine/davos/20131116"></my-page-alpine-davos-20131116>
          <my-page-alpine-arlberg-20131210 name="/alpine/arlberg/20131210"></my-page-alpine-arlberg-20131210>
          <my-page-alpine-flumserberg-20131211 name="/alpine/flumserberg/20131211"></my-page-alpine-flumserberg-20131211>
          <my-page-alpine-gargellen-20131208 name="/alpine/gargellen/20131208"></my-page-alpine-gargellen-20131208>
          <my-page-alpine-ischgl-20131201 name="/alpine/ischgl/20131201"></my-page-alpine-ischgl-20131201>
          <my-page-alpine-alpstein-20131013 name="/alpine/alpstein/20131013"></my-page-alpine-alpstein-20131013>
          <my-page-alpine-damuels-20130824 name="/alpine/damuels/20130824"></my-page-alpine-damuels-20130824>
          <my-page-alpine-laax-20120331 name="/alpine/laax/20120331"></my-page-alpine-laax-20120331>
          <my-page-alpine-ischgl-20130428 name="/alpine/ischgl/20130428"></my-page-alpine-ischgl-20130428>
          <my-page-alpine-arlberg-20130421 name="/alpine/arlberg/20130421"></my-page-alpine-arlberg-20130421>
          <my-page-alpine-disentis-20130518 name="/alpine/disentis/20130518"></my-page-alpine-disentis-20130518>
          <my-page-alpine-davos-20130414 name="/alpine/davos/20130414"></my-page-alpine-davos-20130414>
          <my-page-alpine-davos-20130413 name="/alpine/davos/20130413"></my-page-alpine-davos-20130413>
          <my-page-alpine-flumserberg-20130402 name="/alpine/flumserberg/20130402"></my-page-alpine-flumserberg-20130402>
          <my-page-alpine-ischgl-20130410 name="/alpine/ischgl/20130410"></my-page-alpine-ischgl-20130410>
          <my-page-alpine-arlberg-20130409 name="/alpine/arlberg/20130409"></my-page-alpine-arlberg-20130409>
          <my-page-alpine-lenzerheide-20130406 name="/alpine/lenzerheide/20130406"></my-page-alpine-lenzerheide-20130406>
          <my-page-alpine-montafon-20130404 name="/alpine/montafon/20130404"></my-page-alpine-montafon-20130404>
          <my-page-alpine-pizol-20130401 name="/alpine/pizol/20130401"></my-page-alpine-pizol-20130401>
          <my-page-alpine-obersaxen-20130223 name="/alpine/obersaxen/20130223"></my-page-alpine-obersaxen-20130223>
          <my-page-alpine-arlberg-20121231 name="/alpine/arlberg/20121231"></my-page-alpine-arlberg-20121231>
          <my-page-alpine-arlberg-20121224 name="/alpine/arlberg/20121224"></my-page-alpine-arlberg-20121224>
          <my-page-alpine-davos-20130101 name="/alpine/davos/20130101"></my-page-alpine-davos-20130101>
          <my-page-alpine-lenzerheide-20121229 name="/alpine/lenzerheide/20121229"></my-page-alpine-lenzerheide-20121229>
          <my-page-alpine-montafon-20121219 name="/alpine/montafon/20121219"></my-page-alpine-montafon-20121219>
          <my-page-alpine-arlberg-20121222 name="/alpine/arlberg/20121222"></my-page-alpine-arlberg-20121222>
          <my-page-alpine-arlberg-20121220 name="/alpine/arlberg/20121220"></my-page-alpine-arlberg-20121220>
          <my-page-alpine-lenzerheide-20121217 name="/alpine/lenzerheide/20121217"></my-page-alpine-lenzerheide-20121217>
          <my-page-alpine-laterns-20121216 name="/alpine/laterns/20121216"></my-page-alpine-laterns-20121216>
          <my-page-alpine-damuels-20121214 name="/alpine/damuels/20121214"></my-page-alpine-damuels-20121214>
          <my-page-alpine-flumserberg-20121212 name="/alpine/flumserberg/20121212"></my-page-alpine-flumserberg-20121212>
          <my-page-alpine-alpstein-20121211 name="/alpine/alpstein/20121211"></my-page-alpine-alpstein-20121211>
          <my-page-alpine-davos-20121209 name="/alpine/davos/20121209"></my-page-alpine-davos-20121209>
          <my-page-alpine-boedele-20121201 name="/alpine/boedele/20121201"></my-page-alpine-boedele-20121201>
          <my-page-alpine-flumserberg-20121020 name="/alpine/flumserberg/20121020"></my-page-alpine-flumserberg-20121020>
          <my-page-alpine-toggenburg-20120819 name="/alpine/toggenburg/20120819"></my-page-alpine-toggenburg-20120819>
          <my-page-alpine-arlberg-20120421 name="/alpine/arlberg/20120421"></my-page-alpine-arlberg-20120421>
          <my-page-alpine-arlberg-20120412 name="/alpine/arlberg/20120412"></my-page-alpine-arlberg-20120412>
          <my-page-alpine-arlberg-20120410 name="/alpine/arlberg/20120410"></my-page-alpine-arlberg-20120410>
          <my-page-alpine-lenzerheide-20120409 name="/alpine/lenzerheide/20120409"></my-page-alpine-lenzerheide-20120409>
          <my-page-alpine-lenzerheide-20120406 name="/alpine/lenzerheide/20120406"></my-page-alpine-lenzerheide-20120406>
          <my-page-alpine-davos-20120403 name="/alpine/davos/20120403"></my-page-alpine-davos-20120403>
          <my-page-alpine-arlberg-20120402 name="/alpine/arlberg/20120402"></my-page-alpine-arlberg-20120402>
          <my-page-alpine-pizol-20120324 name="/alpine/pizol/20120324"></my-page-alpine-pizol-20120324>
          <my-page-alpine-montafon-20170109 name="/alpine/montafon/20170109"></my-page-alpine-montafon-20170109>
          <my-page-alpine-damuels-20170209 name="/alpine/damuels/20170209"></my-page-alpine-damuels-20170209>
          <my-page-alpine-laax-20170320 name="/alpine/laax/20170320"></my-page-alpine-laax-20170320>
          <my-page-alpine-lenzerheide-20170321 name="/alpine/lenzerheide/20170321"></my-page-alpine-lenzerheide-20170321>
          <my-page-alpine-davos-20170327 name="/alpine/davos/20170327"></my-page-alpine-davos-20170327>
          <my-page-alpine-arlberg-20170414 name="/alpine/arlberg/20170414"></my-page-alpine-arlberg-20170414>
          <my-page-alpine-ischgl-20170429 name="/alpine/ischgl/20170429"></my-page-alpine-ischgl-20170429>
          <my-page-alpine-kaunertal-20170506 name="/alpine/kaunertal/20170506"></my-page-alpine-kaunertal-20170506>
          <my-page-alpine-speer-20170603 name="/alpine/speer/20170603"></my-page-alpine-speer-20170603>
        </iron-pages>
      </app-header-layout>
      <app-drawer>
        <div>
          <my-menu items="[[items]]" page="{{page}}" />
        </div>
      </app-drawer>
    </app-drawer-layout>
  </template>

  <script>
    Polymer({
      is: 'my-app',

      properties: {
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        }
      },

      observers: [
        '_routeChanged(route)',
        '_changeMetatags(page, items)'
      ],

      _routeChanged: function(route) {
        if (route.path == '/') {
          this.page = '/start'
        } else {
          this.page = route.path;
        }
      },

      _pageChanged: function(page) {
        var resolvedPageUrl = this.resolveUrl('pages' + page + '.html');
        this.importHref(resolvedPageUrl, this._lazyLoader.bind(this, page), this._showPage404, false);
      },

      _lazyLoader: function(page) {
        if (!this.items) {
          this.$.itemsLoader.generateRequest();
        }
        this.$.drawerLayout.resetLayout();
        this.$.headerLayout.resetLayout();
        ga('set', 'page', page);
        ga('send', 'pageview');
      },

      _showPage404: function() {
        this.page = '/404';
      },

      _changeMetatags: function(page, items) {
        if (page && items) {
          var names = page.split('/').slice(1);
          var item = this._findItemByNames(items, names);
          var title = 'www.dplate.de';
          if (item) {
            if (item.subLabel) {
              title = item.subLabel + ' ' + item.label;
            } else {
              title = item.label;
            }
          }
          document.title = title;
        }
      },

      _findItemByNames: function(items, names) {
        var item = this._findItemByName(items, names[0]);
        if (item && item.subs && names.length > 1) {
          return this._findItemByNames(item.subs, names.slice(1));
        } else {
          return item;
        }
      },

      _findItemByName: function(items, name) {
        return items.find(function(item) {
          return item.name == name;
        });
      }
    });
  </script>
</dom-module>
