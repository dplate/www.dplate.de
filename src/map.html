<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../map-loader.html">

<dom-module id="my-map">
  <template>
    <style>
      #cesiumContainer {
        height: calc(100vh - 100px);
      }
    </style>
    <div id="cesiumContainer"></div>
  </template>

  <script>
    Polymer({
      is: 'my-map',

      properties: { },

      ready: function() {
        this.scopeSubtree(this.$.cesiumContainer, true);
      },

      attached: function() {
        fetch('/tracks/test_long.gpx').then(response => response.text()).then(text => {
          const doc = (new window.DOMParser()).parseFromString(text, 'text/xml');

          // Swiss extent
          const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider : new Cesium.CesiumTerrainProvider({
              url : '//3d.geo.admin.ch/1.0.0/ch.swisstopo.terrain.3d/default/20160115/4326/',
              requestVertexNormals: true
            }),
            baseLayerPicker : false,
            geocoder: false,
            animation: true,
            fullscreenButton: false,
            homeButton: false,
            infoBox: false,
            sceneModePicker: false,
            selectionIndicator: false,
            timeline: false,
            navigationHelpButton: false,
            navigationInstructionsInitiallyVisible: false,
            scene3DOnly: true,
            imageryProvider : new Cesium.BingMapsImageryProvider({
              url : 'https://dev.virtualearth.net',
              key : 'AkvC0n8biVNXoCbpiAc4p3g7S9ZHoUWvlpgcJKYQd8FhCA5sn6C8OUmhIR8IEO0X',
              mapStyle : Cesium.BingMapsStyle.AERIAL
            })
          });

          viewer.clock.shouldAnimate = false;
          viewer.scene.globe.enableLighting = true;
          viewer.scene.globe.depthTestAgainstTerrain = true;

          const sampledPosition = new Cesium.SampledPositionProperty();
          let startTime = null;
          let stopTime = null;
          const positions = [];
          Array.prototype.slice.call(doc.getElementsByTagName('trkpt')).forEach((trackPoint) => {
            const position = Cesium.Cartesian3.fromDegrees(trackPoint.getAttribute('lon'), trackPoint.getAttribute('lat'), 0);
            if (positions.length > 0 && Cesium.Cartesian3.distance(position, positions[positions.length - 1]) < 10) return;
            const date = Cesium.JulianDate.fromIso8601(trackPoint.getElementsByTagName('time')[0].firstChild.nodeValue);
            if (!startTime) startTime = date;
            stopTime = date;
            sampledPosition.addSample(date, position);
            positions.push(position);
          });

          const corridor = new Cesium.CorridorGraphics({
            positions,
            material: Cesium.Color.RED,
            width: 2.0
          });

          viewer.entities.add(new Cesium.Entity({
            id : 'track',
            corridor
          }));

          const billboard = new Cesium.BillboardGraphics({
            image: '/external/Cesium/Assets/Textures/pin.svg',
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
            depthTestAgainstTerrain: 0
          });

          const pin = new Cesium.Entity({
            id : 'pin',
            billboard,
            position: sampledPosition
          });
          viewer.entities.add(pin);

          const hdRectangle = Cesium.Rectangle.fromCartesianArray(positions, Cesium.Ellipsoid.WGS84);
          hdRectangle.east += 0.005; hdRectangle.west -= 0.005; hdRectangle.north += 0.003; hdRectangle.south -= 0.003;
          viewer.scene.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
            url: "//wmts{s}.geo.admin.ch/1.0.0/ch.swisstopo.swissimage-product/default/current/4326/{z}/{y}/{x}.jpeg",
            subdomains: '56789',
            minimumLevel: 8,
            maximumLevel: 17,
            tilingScheme: new Cesium.GeographicTilingScheme({
              numberOfLevelZeroTilesX: 2,
              numberOfLevelZeroTilesY: 1
            }),
            rectangle: hdRectangle,
            credit: 'geodata Â© swisstopo'
          }));

          viewer.clock.startTime = startTime;
          viewer.clock.stopTime = stopTime;
          viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;
          viewer.clock.currentTime = startTime;
          viewer.clock.multiplier = 100;

          let currentTilt = -15;
          viewer.clock.onTick.addEventListener(() => {
            const futureTime = new Cesium.JulianDate();
            Cesium.JulianDate.addSeconds(viewer.clock.currentTime, 20 * 60, futureTime);
            const secondsAfterEnd = Cesium.JulianDate.secondsDifference(futureTime, stopTime);
            if (secondsAfterEnd > 0) Cesium.JulianDate.addSeconds(startTime, secondsAfterEnd, futureTime);

            const currentCart = Cesium.Cartographic.fromCartesian(pin.position.getValue(viewer.clock.currentTime));
            const futureCart = Cesium.Cartographic.fromCartesian(pin.position.getValue(futureTime));
            const geodesic = new Cesium.EllipsoidGeodesic(currentCart, futureCart);

            const currentHeight = viewer.scene.globe.getHeight(currentCart) || currentCart.height;
            const realCurrentPos = Cesium.Cartesian3.fromRadians(currentCart.longitude, currentCart.latitude, currentHeight);

            const terrainHeightUnderCamera = viewer.scene.globe.getHeight(viewer.camera.positionCartographic);
            if (terrainHeightUnderCamera) {
              currentTilt += (viewer.camera.positionCartographic.height - (200 + terrainHeightUnderCamera)) * 0.01;
              currentTilt = Math.max(currentTilt, -90);
              currentTilt = Math.min(currentTilt, 0);
            }

            viewer.camera.lookAt(realCurrentPos, new Cesium.HeadingPitchRange(geodesic.startHeading, Cesium.Math.toRadians(currentTilt), 500));
          });
        });
      }
    });
  </script>
</dom-module>