<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../map-loader.html">

<dom-module id="my-map">
  <template>
    <style>
      .cesiumContainer {
        position: fixed;
        line-height: 0.7;
        font-size: 8px;
        box-shadow: 0 0 20px 0 rgba(0,0,0,0.75);
        cursor: all-scroll;
      }
      .cesiumContainer .cesium-credit-image img {
        max-width: 5vw;
      }
      .cesiumContainer .cesium-viewer-bottom {
        bottom: 3px !important;
      }
      .cesiumContainer.wait {
        cursor: wait;
      }
      .cesiumContainer.teaser {
        right: 5px;
        bottom: 5px;
        height: 30vh;
        width: 30vw;
      }
      @media (max-width: 640px) and (orientation: portrait) {
        .cesiumContainer.teaser {
          right: 0;
          bottom: 0;
          height: 30vh;
          width: 100%;
        }
      }
      @media (max-height: 400px) {
        .cesiumContainer.teaser {
          right: 0;
          bottom: 0;
          width: 30vw;
          height: 100%;
        }
        .cesiumContainer.teaser .cesium-viewer-bottom {
          right: 40px;
        }
      }
      .cesiumContainer.fullscreen {
        left: 0;
        top: 0;
        height: 100%;
        width: 100%;
      }
      .cesiumContainer.fullscreen .cesium-viewer-bottom {
        right: 40px;
      }
      .cesiumContainer.icon {
        display: none
      }
      #resizeIcon {
        position: fixed;
        cursor: pointer;
        transform: scale(-1, 1);
        opacity: 0.5;
        filter: invert(100%);
        height: 24px;
        width: 24px;
        box-shadow: 0 0 5px 0 rgba(255,255,255,1);
      }
      #resizeIcon:hover {
        opacity: 1.0;
      }
      #resizeIcon.teaser {
        right:  calc(30vw - 25px);
        bottom: calc(30vh - 25px);
      }
      @media (max-width: 640px) and (orientation: portrait) {
        #resizeIcon.teaser {
          right: inherit;
          left: 5px;
          bottom: calc(30vh - 30px);
        }
      }
      @media (max-height: 400px) {
        #resizeIcon.teaser {
          right: 5px;
          bottom: 5px;
        }
      }
      #resizeIcon.fullscreen {
        right: 5px;
        bottom: 5px;
      }
      #resizeIcon.icon {
        display: none;
      }
      #mapIcon {
        position: fixed;
        cursor: pointer;
        height: 35px;
        width: 35px;
        right: 5px;
        bottom: 5px;
        opacity: 0.5;
      }
      #mapIcon:hover {
        opacity: 1.0;
      }
      #mapIcon.teaser {
        display: none;
      }
      #mapIcon.fullscreen {
        display: none;
      }
    </style>
    <div id="cesiumContainer[[name]]" class$="cesiumContainer [[size]] [[mapStatus]]"></div>
    <img on-tap="changeSize" id="resizeIcon" class$="[[size]]" src="/images/icons/resize.svg" />
    <img on-tap="changeSize" id="mapIcon" class$="[[size]]" src="/images/icons/map.svg" />
  </template>

  <script>
    Polymer({
      is: 'my-map',
      viewer: null,
      currentTilt: -15,
      targetTime: null,

      properties: {
        name: String,
        gpxPath: {
          type: String,
          reflectToAttribute: true
        },
        time: {
          type: String,
          observer: 'timeChanged',
          reflectToAttribute: true
        },
        size: {
          type: String,
          value: 'teaser',
          reflectToAttribute: true
        },
        mapStatus: {
          type: String,
          value: 'wait'
        }
      },

      changeSize: function() {
        if (this.size === 'teaser') {
          this.size = 'fullscreen';
        } else if (this.size === 'fullscreen') {
          this.size = 'icon';
        } else this.size = 'teaser';
      },

      timeChanged: function() {
        this.targetTime = Cesium.JulianDate.fromIso8601(this.time);
      },

      updateCamera: function() {
        if (!this.viewer.clock.shouldAnimate) return;

        const futureTime = new Cesium.JulianDate();
        Cesium.JulianDate.addSeconds(this.viewer.clock.currentTime, 20 * 60, futureTime);
        const secondsAfterEnd = Cesium.JulianDate.secondsDifference(futureTime, this.viewer.clock.stopTime);
        if (secondsAfterEnd > 0) Cesium.JulianDate.addSeconds(this.viewer.clock.startTime, secondsAfterEnd, futureTime);

        const pin = this.viewer.entities.getById('pin');
        const currentCart = Cesium.Cartographic.fromCartesian(pin.position.getValue(this.viewer.clock.currentTime));
        const futureCart = Cesium.Cartographic.fromCartesian(pin.position.getValue(futureTime));
        const geodesic = new Cesium.EllipsoidGeodesic(currentCart, futureCart);

        const currentHeight = this.viewer.scene.globe.getHeight(currentCart) || currentCart.height;
        const realCurrentPos = Cesium.Cartesian3.fromRadians(currentCart.longitude, currentCart.latitude, currentHeight);

        const terrainHeightUnderCamera = this.viewer.scene.globe.getHeight(this.viewer.camera.positionCartographic);
        if (terrainHeightUnderCamera) {
          this.currentTilt += (this.viewer.camera.positionCartographic.height - (200 + terrainHeightUnderCamera)) * 0.01;
          this.currentTilt = Math.max(this.currentTilt, -90);
          this.currentTilt = Math.min(this.currentTilt, 0);
        }

        this.viewer.camera.lookAt(realCurrentPos, new Cesium.HeadingPitchRange(geodesic.startHeading, Cesium.Math.toRadians(this.currentTilt), 500));
      },

      updateSpeed: function() {
        if (!this.targetTime) return;

        const timeDifference = Cesium.JulianDate.secondsDifference(this.targetTime, this.viewer.clock.currentTime);
        let multiplier = timeDifference;
        multiplier = Math.max(multiplier, -10000);
        multiplier = Math.min(multiplier, 10000);
        this.viewer.clock.multiplier = multiplier;
        if (Math.abs(multiplier) < 20) {
          this.viewer.clock.shouldAnimate = false;
          this.mapStatus = 'free';
        } else {
          this.viewer.clock.shouldAnimate = true;
          this.mapStatus = 'wait';
        }
      },

      tickChanged: function() {
        this.updateCamera();
        this.updateSpeed();
      },

      ready: function() {
        this.scopeSubtree(this.$$('#cesiumContainer' + this.name), true);
      },

      attached: function() {
        this.loadTrack().then(this.setupMap.bind(this));
      },

      loadTrack: function() {
        return fetch(this.gpxPath).then(response => response.text());
      },

      setupMap: function(gpxRaw) {
        this.setupViewer();
        const trackData = this.parseTrackData(gpxRaw);
        this.addTrack(trackData.positions);
        this.addPin(trackData.sampledPosition);
        this.addSwissSatellite(trackData.positions);
        this.setupClock(trackData.startTime, trackData.stopTime);
      },

      setupViewer: function() {
        console.log('test');
        console.log('cesiumContainer' + this.name);
        this.viewer = new Cesium.Viewer('cesiumContainer' + this.name, {
          terrainProvider : new Cesium.CesiumTerrainProvider({
            url : '//3d.geo.admin.ch/1.0.0/ch.swisstopo.terrain.3d/default/20160115/4326/',
            requestVertexNormals: true
          }),
          baseLayerPicker : false,
          geocoder: false,
          animation: false,
          fullscreenButton: false,
          homeButton: false,
          infoBox: false,
          sceneModePicker: false,
          selectionIndicator: false,
          timeline: false,
          navigationHelpButton: false,
          navigationInstructionsInitiallyVisible: false,
          scene3DOnly: true,
          imageryProvider : new Cesium.BingMapsImageryProvider({
            url : 'https://dev.virtualearth.net',
            key : 'AkvC0n8biVNXoCbpiAc4p3g7S9ZHoUWvlpgcJKYQd8FhCA5sn6C8OUmhIR8IEO0X',
            mapStyle : Cesium.BingMapsStyle.AERIAL
          })
        });

        this.viewer.scene.globe.enableLighting = true;
        this.viewer.scene.globe.depthTestAgainstTerrain = true;
      },

      parseTrackData: function(gpxRaw) {
        const trackData = {
          startTime: null,
          stopTime: null,
          sampledPosition: new Cesium.SampledPositionProperty(),
          positions: []
        };
        const doc = (new window.DOMParser()).parseFromString(gpxRaw, 'text/xml');
        Array.prototype.slice.call(doc.getElementsByTagName('trkpt')).forEach((trackPoint) => {
          const position = Cesium.Cartesian3.fromDegrees(trackPoint.getAttribute('lon'), trackPoint.getAttribute('lat'), 0);
          if (trackData.positions.length > 0 && Cesium.Cartesian3.distance(position, trackData.positions[trackData.positions.length - 1]) < 10) return;
          const date = Cesium.JulianDate.fromIso8601(trackPoint.getElementsByTagName('time')[0].firstChild.nodeValue);
          if (!trackData.startTime) trackData.startTime = date;
          trackData.stopTime = date;
          trackData.sampledPosition.addSample(date, position);
          trackData.positions.push(position);
        });
        return trackData;
      },

      addTrack: function(positions) {
        const corridor = new Cesium.CorridorGraphics({
          positions,
          material: Cesium.Color.RED,
          width: 2.0
        });

        this.viewer.entities.add(new Cesium.Entity({
          id : 'track',
          corridor
        }));
      },

      addPin: function(sampledPosition) {
        const billboard = new Cesium.BillboardGraphics({
          image: '/external/Cesium/Assets/Textures/pin.svg',
          heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
          depthTestAgainstTerrain: 0
        });
        const pin = new Cesium.Entity({
          id : 'pin',
          billboard,
          position: sampledPosition
        });
        this.viewer.entities.add(pin);
      },

      addSwissSatellite: function(positions) {
        const hdRectangle = Cesium.Rectangle.fromCartesianArray(positions, Cesium.Ellipsoid.WGS84);
        hdRectangle.east += 0.001; hdRectangle.west -= 0.001; hdRectangle.north += 0.0005; hdRectangle.south -= 0.0005;
        this.viewer.scene.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
          url: "//wmts{s}.geo.admin.ch/1.0.0/ch.swisstopo.swissimage-product/default/current/4326/{z}/{y}/{x}.jpeg",
          subdomains: '56789',
          minimumLevel: 8,
          maximumLevel: 17,
          tilingScheme: new Cesium.GeographicTilingScheme({
            numberOfLevelZeroTilesX: 2,
            numberOfLevelZeroTilesY: 1
          }),
          rectangle: hdRectangle,
          credit: 'geodata © swisstopo'
        }));
      },

      setupClock: function(startTime, stopTime) {
        this.viewer.clock.startTime = startTime;
        this.viewer.clock.stopTime = stopTime;
        this.viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;
        this.viewer.clock.currentTime = startTime;
        this.viewer.clock.onTick.addEventListener(this.tickChanged.bind(this));
      }
    });
  </script>
</dom-module>