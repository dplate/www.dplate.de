<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="pages/styles.html">
<script src="/external/exif-js/exif.js"></script>

<dom-module id="my-report">
  <template>
    <style>
      :host {
        display: block;
        margin: 16px;
        color: white;
      }
      ::content a {
        color: #CFE0C3;
      }
      ::content a:visited {
        color: #9EC1A3;
      }
      h1 {}
      p, figcaption {
        max-width: 800px;
      }
      figure {
        margin: 0 0 25px 0;
      }
      .landmark img {
        max-width: 100%;
        max-height: calc(100vh - 75px);
      }
    </style>

    <iron-ajax auto id="contentLoader" url="/res[[name]]/content.json" handle-as="json" last-response="{{content}}"></iron-ajax>

    <h1>[[content.title]]</h1>
    <p inner-h-t-m-l="[[content.intro]]"></p>
    <template id="content" is="dom-repeat" items="[[content.landmarks]]" as="landmark">
      <figure class="landmark">
        <template is="dom-repeat" items="[[landmark.photos]]" as="photo">
          <img src="[[getPhotoPath(photo)]]" />
        </template>
        <figcaption inner-h-t-m-l="[[landmark.text]]"></figcaption>
      </figure>
    </template>
    <p inner-h-t-m-l="[[content.outro]]"></p>
    <my-map gpx-path="/res[[name]]/track.gpx" time="[[time]]"></my-map>
  </template>

  <script>
    Polymer({
      is: 'my-report',
      images: [],

      properties: {
        name: String,
        time: String,
        content:  {
          type: Object,
          observer: 'showContent'
        }
      },

      showContent: function() {
        this.$.content.render();
        this.retrieveImageDates();
      },

      getCardType: function(card) {
        if (card.photos) return 'pictureCard';
        else return '';
      },

      getPhotoPath: function(photo) {
        var match = this.name.match(/^\/.*?\/(.*)$/);
        if (match) {
          return '/photos/' + match[1] + '/' + photo + '.jpg';
        }
      },

      scrollHandler: function() {
        let nearestImage;
        let minDistance = Number.MAX_SAFE_INTEGER;
        this.images.forEach(function(image) {
          const distance = Math.abs(this.scrollY - image.offsetTop);
          if (distance < minDistance) {
            minDistance = distance;
            nearestImage = image;
          }
        });
        if (nearestImage) {
          this.set('time', nearestImage.getAttribute('data-time'));
        }
      },

      ready: function() {
        window.addEventListener('scroll', this.scrollHandler.bind(this));
        this.importHref('/src/map.html', null, null, false);
      },

      retrieveImageDate: function(image) {
        const self = this;
        EXIF.getData(image, function() {
          const exifDate = EXIF.getTag(this, 'DateTimeOriginal');
          if (exifDate) {
            const [date, time] = exifDate.split(' ');
            image.setAttribute('data-time', date.replace(/:/g, '-') + 'T' + time);
            self.images.push(image);
            self.scrollHandler();
          }
        });
      },

      retrieveImageDates: function() {
        this.images = [];
        const imgElements = document.querySelectorAll('.landmark img');
        for (let i=0, image; image = imgElements[i]; i++) {
          if (image.complete) {
            this.retrieveImageDate(image);
          } else {
            image.onload = this.retrieveImageDate.bind(this, image);
          }
        }
      }
    });
  </script>
</dom-module>